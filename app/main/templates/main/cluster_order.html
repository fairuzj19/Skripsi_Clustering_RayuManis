{% set title = 'Visuzalization Order' %}
{% set page = 'cluster_order.html' %}
{% extends 'base.html' %}

{% block plugins_css %}
  <link rel="stylesheet" href="../node_modules/jqvmap/dist/jqvmap.min.css">
  <link rel="stylesheet" href="../node_modules/summernote/dist/summernote-bs4.css">
  <link rel="stylesheet" href="../node_modules/owl.carousel/dist/assets/owl.carousel.min.css">
  <link rel="stylesheet" href="../node_modules/owl.carousel/dist/assets/owl.theme.default.min.css">
{% endblock %}

{% block content %}
  <div class="main-content">
      <div class="col-md">
          <section class="section">
              <div class="section-header">
                  <h1>Visualisasi Cluster Sheet Order</h1>
              </div>
              <div class="row">
                <div class="col-lg-8 col-md-12 col-12 col-sm-12">
                  <div class="card">
                    <div class="card-header" style="padding-left: 30px;">
                      <h4>Visualisasi Cluster Order</h4>
                    </div>
                    <div class="card-body">
                      <div id="clusterOrder" ></div>
                    </div>
                    <div class="card-header">
                      <ul>
                          <li><strong>Cluster 0 (Merah):</strong> Kelompok ini cenderung memiliki nilai frequency dan monetary yang cukup tinggi serta recency yang rendah.</li>
                          <li><strong>Cluster 1 (Biru):</strong> Pelanggan dengan frequency yang rendah hingga sedang, nilai transaksi tinggi, tetapi recency yang tinggi.</li>
                      </ul>
                  </div>                  
                  </div>
                </div>
                <div class="col-lg-4 col-md-12 col-12 col-sm-12">
                  <div class="card">
                    <div class="card-header">
                      <h4>Presentase Cluster Order</h4>
                    </div>
                    <div class="card-body">
                        <canvas id="OrderPieChart" height="126"></canvas>
                      </div>
                  </div>
                  <div class="card">
                    <div class="card-header">
                      <h4>Data Cluster Order</h4>
                    </div>
                    <div class="card-body">
                      <table>
                        <thead>
                            <tr>
                                <th>Cluster</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cluster, count in data2.items() %}
                            <tr>
                                <td>{{ cluster }}</td>
                                <td>{{ count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                  </div>
                </div>
              </div>
                <div class="row">
                  <div class="card" style="margin: 12px; width: 955px;">
                    <div class="card-header">
                      <h4>RFM Sheet Order</h4>
                    </div>
                    <div class="card-body">
                        <div id="scatterPlot1"></div>
                        <div id="scatterPlot2"></div>
                        <div id="scatterPlot3"></div>
                    </div>
                  </div>
              </div>
              <div class="row">
                <div class="card" style="margin: 12px; padding-top: 20px; width: 955px;">
                  <div class="card-header">
                      <ul>                    
                          <strong>Recency vs. Frequency</strong>
                          <li><strong>Cluster 0 (Merah):</strong> Pelanggan dalam cluster ini memiliki frequency tinggi (sering bertransaksi) dan recency rendah (baru-baru ini bertransaksi).</li>
                          <li><strong>Cluster 1 (Biru):</strong> Pelanggan dalam cluster ini memiliki frequency rendah hingga sedang dan recency yang lebih tinggi dibanding Cluster 0.</li>
                          <strong>Recency vs. Monetary</strong>
                          <li><strong>Cluster 0 (Merah):</strong> Pelanggan dalam cluster ini memiliki monetary tinggi dan recency rendah.</li>
                          <li><strong>Cluster 1 (Biru):</strong> Pelanggan dalam cluster ini memiliki monetary bervariasi namun umumnya lebih rendah dari Cluster 0, dan recency lebih tinggi.</li>
                          <strong>Frequency vs. Monetary</strong>
                          <li><strong>Cluster 0 (Merah):</strong> Pelanggan dalam cluster ini memiliki frequency dan monetary tinggi.</li>
                          <li><strong>Cluster 1 (Biru):</strong> Pelanggan dalam cluster ini memiliki sebaran yang lebih luas, dengan kecenderungan frequency dan monetary yang lebih rendah dari Cluster 0.</li>
                      </ul>
                  </div>
                </div>
                </div>
                <div class="row">
                  <div class="card" style="margin: 12px; width: 955px;">
                    <div class="card-header">
                      <h4>Insight</h4>
                    </div>
                    <div class="card-body">
                      <table>
                        <thead>
                            <tr style="background-color: #f2f2f2;">
                                <th style="width: 200px !important;">Cluster</th>
                                <th style="width: 330px !important;">Karakteristik</th>
                                <th>Keterangan</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="text-align: left;"><b>Cluster 0</b><br><b>(Loyal Customers)</b></td>
                                <td style="text-align: left;">
                                    - <b>Recency rendah</b><br>
                                    - <b>Frequency tinggi</b><br>
                                    - <b>Monetary tinggi</b>
                                </td>
                                <td style="text-align: left;">
                                    <p style="font-size: 14px;">Pelanggan ini merupakan pelanggan setia yang masih aktif berbelanja hingga saat ini. 
                                      Mereka melakukan pembelian secara rutin dan dalam jumlah besar. Karakteristik ini menunjukkan bahwa mereka 
                                      sangat loyal dan merupakan kontributor utama terhadap pendapatan.</p>
                                </td>
                            </tr>
                            <tr>
                                <td style="text-align: left;"><b>Cluster 1</b><br><b>(At-Risk Customers)</b></td>
                                <td style="text-align: left;">
                                    - <b>Recency tinggi</b> <br>
                                    - <b>Frequency rendah hingga sedang</b> <br>
                                    - <b>Monetary tinggi</b>
                                </td>
                                <td style="text-align: left;">
                                   <p style="font-size: 14px;">Pelanggan ini pernah berbelanja dalam jumlah besar, 
                                    tetapi sudah cukup lama tidak melakukan pembelian. Frekuensi transaksinya menurun. 
                                    Mereka adalah pelanggan bernilai tinggi yang berisiko hilang.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>     
                    </div>
                  </div>
                  </div>
                <div class="row mb-4" style="margin-bottom: 5px !important;">
                <!-- Tombol Dashboard -->
                <div class="col-lg-6 col-md-6 col-sm-12">
                  <a href="{{ url_for('main.dashboard') }}"
                    class="d-flex align-items-center justify-content-center gap-2 border rounded-4 px-4 py-2 w-100 text-decoration-none"
                    style="font-size: 16px; border-color: #d1d5db; background-color: #ffffff; color: #212529; transition: background-color 0.2s ease, color 0.2s ease;"
                    onmouseover="this.style.backgroundColor='#6777ef'; this.style.color='#ffffff'; this.querySelector('i').style.color='#ffffff';"
                    onmouseout="this.style.backgroundColor='#ffffff'; this.style.color='#212529'; this.querySelector('i').style.color='#212529';">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-house-door" viewBox="0 0 16 16">
                      <path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4z"/>
                    </svg>Dashboard
                  </a>
                </div>

                <!-- Tombol Insight Cluster -->
                <div class="col-lg-6 col-md-6 col-sm-12">
                  <a href="{{ url_for('main.table1') }}"
                    class="d-flex align-items-center justify-content-center gap-2 border rounded-4 px-4 py-2 w-100 text-decoration-none"
                    style="font-size: 16px; border-color: #d1d5db; background-color: #ffffff; color: #212529; transition: background-color 0.2s ease, color 0.2s ease;"
                    onmouseover="this.style.backgroundColor='#6777ef'; this.style.color='#ffffff'; this.querySelector('i').style.color='#ffffff';"
                    onmouseout="this.style.backgroundColor='#ffffff'; this.style.color='#212529'; this.querySelector('i').style.color='#212529';">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-table" viewBox="0 0 16 16">
                      <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm15 2h-4v3h4zm0 4h-4v3h4zm0 4h-4v3h3a1 1 0 0 0 1-1zm-5 3v-3H6v3zm-5 0v-3H1v2a1 1 0 0 0 1 1zm-4-4h4V8H1zm0-4h4V4H1zm5-3v3h4V4zm4 4H6v3h4z"/>
                    </svg> Data Cluster Order
                  </a>
                </div>
              </div>
                  </div>
              </div>
          </section>
      </div>
  </div>
{% endblock content %}

{% block plugins_js %}
  <script src="../node_modules/simpleweather/jquery.simpleWeather.min.js"></script>
  <script src="../node_modules/chart.js/dist/Chart.min.js"></script>
  <script src="../node_modules/jqvmap/dist/jquery.vmap.min.js"></script>
  <script src="../node_modules/jqvmap/dist/maps/jquery.vmap.world.js"></script>
  <script src="../node_modules/summernote/dist/summernote-bs4.js"></script>
  <script src="../node_modules/chocolat/dist/js/jquery.chocolat.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    const jsonData = {{data|safe}}
    const clusterTraces = [];
      const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']; 
  
      jsonData.clusters.forEach((point, index) => {
        if (!clusterTraces[point.cluster]) {
          clusterTraces[point.cluster] = {
            x: [],
            y: [],
            z: [],
            mode: "markers",
            type: "scatter3d",
            marker: { size: 5, color: colors[point.cluster] },
            name: `Cluster ${point.cluster}`,
          };
        }
        clusterTraces[point.cluster].x.push(point.x);
        clusterTraces[point.cluster].y.push(point.y);
        clusterTraces[point.cluster].z.push(point.z);
      });
  
      const layout = {
        title: "3D Cluster Visualization",
        scene: {
          xaxis: { title: "Recency" }, // ✅ Label for X-axis
          yaxis: { title: "Frequency" }, // ✅ Label for Y-axis
          zaxis: { title: "Monetary" }, // ✅ Label for Z-axis
        },
      };
  
      // Extract centroid data points
      const centroidTrace = {
        x: jsonData.centroids.map((c) => c.x),
        y: jsonData.centroids.map((c) => c.y),
        z: jsonData.centroids.map((c) => c.z),
        mode: "markers",
        type: "scatter3d",
        marker: { size: 5, color: "black", symbol: "x" },
        name: "Centroids",
      };
  
      // Render plot
      Plotly.newPlot("clusterOrder", [...clusterTraces, centroidTrace], layout);
  </script>

  <script>
    const colors2D = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];

    function createScatterPlot(divId, xKey, yKey, xLabel, yLabel, title) {
        const clusterTraces = [];

        jsonData.clusters.forEach((point) => {
            if (!clusterTraces[point.cluster]) {
                clusterTraces[point.cluster] = {
                    x: [],
                    y: [],
                    mode: "markers",
                    type: "scatter",
                    marker: { size: 8, color: colors2D[point.cluster % colors2D.length] },
                    name: `Cluster ${point.cluster}`
                };
            }
            clusterTraces[point.cluster].x.push(point[xKey]);
            clusterTraces[point.cluster].y.push(point[yKey]);
        });

        // Add centroids
        const centroidTrace = {
            x: jsonData.centroids.map((c) => c[xKey]),
            y: jsonData.centroids.map((c) => c[yKey]),
            mode: "markers",
            type: "scatter",
            marker: { size: 12, color: "black", symbol: "x" },
            name: "Centroids"
        };

        Plotly.newPlot(divId, [...Object.values(clusterTraces), centroidTrace], {
            title: title,
            xaxis: { title: xLabel },
            yaxis: { title: yLabel }
        });
    }

    createScatterPlot("scatterPlot1", "x", "y", "Recency", "Frequency", "Recency vs Frequency");
    createScatterPlot("scatterPlot2", "x", "z", "Recency", "Monetary", "Recency vs Monetary");
    createScatterPlot("scatterPlot3", "y", "z", "Frequency", "Monetary", "Frequency vs Monetary");
</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<script>
  Chart.register(ChartDataLabels);

  // Insert JSON data from Python
  const jsonData2 = {{data2|safe}};

  // Extract labels and values
  const labels = Object.keys(jsonData2);
  const values = Object.values(jsonData2);

  // Calculate the total sum of values
  const total = values.reduce((acc, value) => acc + value, 0);

  // Get the chart element
  const ctx = document.getElementById('OrderPieChart').getContext('2d');

  // Create the Pie Chart
  const OrderPieChart= new Chart(ctx, {
    type: 'pie',
    data: {  
      labels: labels,
      datasets: [{
        data: values,  
        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top', // Move legend to the top
        },
        tooltip: {
          enabled: true, // Show tooltips on hover
          callbacks: {
            label: (tooltipItem) => {
              let dataset = tooltipItem.dataset;
              let value = dataset.data[tooltipItem.dataIndex];
              let percentage = ((value / total) * 100).toFixed(2);
              return `${tooltipItem.label}: ${percentage}%`;
            }
          }
        },
        datalabels: {
          color: 'white', // White text for visibility
          font: {
            weight: 'bold',
            size: 12
          },
          formatter: (value) => {
            let percentage = ((value / total) * 100).toFixed(2);
            return `${percentage}%`; // Show percentage only
          }
        }
      }
    }
  });
</script> 
{% endblock %}

{% block page_js %}
  <script src="../assets/js/page/index-0.js"></script>
{% endblock %}